<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sophia Select</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle cx='16' cy='16' r='14' fill='%23d63031' opacity='.15'/><circle cx='16' cy='16' r='9' fill='none' stroke='%23d63031' stroke-width='1.5' opacity='.4'/><circle cx='16' cy='16' r='4.5' fill='none' stroke='%23d63031' stroke-width='1.5' opacity='.7'/><line x1='16' y1='16' x2='16' y2='2' stroke='%23d63031' stroke-width='2' stroke-linecap='round'/><circle cx='16' cy='5' r='2' fill='%23d63031'/></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #ffffff;
    --surface: #f8f9fa;
    --surface-hover: #f0f1f3;
    --border: #e0e0e6;
    --text: #1a1a2e;
    --text-dim: #555570;
    --text-muted: #888899;
    --accent-arxiv: #d63031;
    --accent-scholar: #2980b9;
    --accent-hn: #e65100;
    --accent-reddit: #e53935;
    --accent-twitter: #1a8cd8;
    --accent-papers: #8e44ad;
    --accent-discussions: #e67e22;
    --accent-blogs: #27ae60;
    --accent-newsletters: #2980b9;
    --accent-researchers: #e91e63;
    --accent-podcasts: #ff9800;
    --accent-conferences: #00897b;
    --accent-opportunities: #5c6bc0;
    --accent-faculty_jobs: #e91e63;
    --tag-bg: rgba(0,0,0,0.04);
    --font-mono: 'IBM Plex Mono', monospace;
    --font-sans: 'IBM Plex Sans', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-sans);
    line-height: 1.6;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* â”€â”€â”€ Header â”€â”€â”€ */
  .header {
    border-bottom: 1px solid var(--border);
    padding: 1.5rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .logo {
    font-family: var(--font-mono);
    font-size: 1.1rem;
    font-weight: 600;
    letter-spacing: -0.02em;
    color: var(--text);
  }

  .logo span {
    color: var(--accent-arxiv);
  }

  .meta-info {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-family: var(--font-mono);
  }

  .header-right {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  /* â”€â”€â”€ Search â”€â”€â”€ */
  .search-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.4rem 0.8rem;
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 0.8rem;
    width: 260px;
    outline: none;
    transition: border-color 0.2s;
  }

  .search-box:focus {
    border-color: var(--text-muted);
  }

  .search-box::placeholder {
    color: var(--text-muted);
  }

  /* â”€â”€â”€ Layout: Sidebar + Main â”€â”€â”€ */
  .main-layout {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-height: 0;
    overflow: hidden;
  }

  /* â”€â”€â”€ Hamburger Tab Selector â”€â”€â”€ */
  .tab-hamburger-wrap {
    position: relative;
    flex-shrink: 0;
    width: 100%;
    z-index: 100;
  }

  .tab-hamburger-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.7rem 1rem;
    font-size: 0.85rem;
    font-family: var(--font-mono);
    color: var(--text);
    background: var(--surface);
    border: none;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.2s;
  }

  .tab-hamburger-btn:hover { background: var(--surface-hover); }

  .hamburger-icon { font-size: 1.1rem; }
  .hamburger-label { font-weight: 600; }
  .hamburger-count { 
    background: var(--tag-bg); 
    padding: 0.1rem 0.5rem; 
    border-radius: 10px; 
    font-size: 0.7rem; 
    color: var(--text-dim); 
  }
  .hamburger-arrow { margin-left: auto; color: var(--text-muted); font-size: 0.8rem; }

  .tab-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-top: none;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    max-height: 70vh;
    overflow-y: auto;
    z-index: 101;
  }

  .tab-dropdown.open { display: flex; flex-direction: column; }

  .tab {
    padding: 0.55rem 1rem;
    font-size: 0.78rem;
    font-family: var(--font-mono);
    color: var(--text-muted);
    cursor: pointer;
    border-left: 2px solid transparent;
    transition: all 0.2s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: none;
    border-top: none;
    border-bottom: none;
    border-right: none;
    text-align: left;
  }

  .tab:hover { color: var(--text-dim); background: var(--surface-hover); }

  .tab.active {
    color: var(--text);
    border-left-color: var(--text);
    background: var(--bg);
  }

  .tab .count {
    background: var(--tag-bg);
    padding: 0.1rem 0.45rem;
    border-radius: 10px;
    font-size: 0.65rem;
    color: var(--text-dim);
    margin-left: auto;
  }

  .tab.active .count {
    color: var(--text);
  }

  .source-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    display: inline-block;
    flex-shrink: 0;
  }

  .main-right {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    overflow-y: auto;
  }

  /* â”€â”€â”€ My Collection Button (header) â”€â”€â”€ */
  .collection-btn {
    padding: 0.35rem 0.8rem;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 6px;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    cursor: pointer;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    transition: opacity 0.2s;
  }
  .collection-btn:hover { opacity: 0.85; }
  .collection-btn .count {
    background: rgba(255,255,255,0.25);
    padding: 0.05rem 0.4rem;
    border-radius: 8px;
    font-size: 0.65rem;
  }

  /* â”€â”€â”€ Stats Bar â”€â”€â”€ */
  .stats-bar {
    display: flex;
    gap: 2rem;
    padding: 1rem 2rem;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
  }

  .stat {
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
  }

  .stat-value {
    font-family: var(--font-mono);
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--text);
  }

  .stat-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* â”€â”€â”€ Content â”€â”€â”€ */
  .content {
    max-width: 1100px;
    margin: 0 auto;
    padding: 1.5rem 2rem;
  }

  .content.grid-mode {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 0.75rem;
    max-width: 100%;
    width: 100%;
    padding: 1.5rem 2rem;
    box-sizing: border-box;
  }

  .content.grid-mode .card {
    margin-bottom: 0;
  }

  .content.grid-mode .grid-section-header {
    grid-column: 1 / -1;
  }

  /* â”€â”€â”€ Card â”€â”€â”€ */
  .card {
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.2rem 1.4rem;
    margin-bottom: 0.75rem;
    background: var(--surface);
    transition: background 0.15s, border-color 0.15s;
    cursor: default;
  }

  .card:hover {
    background: var(--surface-hover);
    border-color: #c8c8d0;
  }

  .card-header {
    display: flex;
    align-items: flex-start;
    gap: 0.8rem;
    margin-bottom: 0.5rem;
  }

  .card-source-indicator {
    width: 3px;
    min-height: 1.2rem;
    border-radius: 2px;
    flex-shrink: 0;
    margin-top: 0.25rem;
  }

  .card-title {
    font-size: 0.95rem;
    font-weight: 500;
    line-height: 1.45;
    color: var(--text);
  }

  .card-title a {
    color: inherit;
    text-decoration: none;
  }

  .card-title a:hover {
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .card-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
    align-items: center;
  }

  .card-authors {
    font-size: 0.78rem;
    color: var(--text-dim);
    margin-top: 0.3rem;
    padding-left: 0.7rem;
  }

  .card-summary {
    font-size: 0.82rem;
    color: var(--text-dim);
    line-height: 1.55;
    margin-top: 0.5rem;
    padding-left: 0.7rem;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .tag {
    font-size: 0.68rem;
    font-family: var(--font-mono);
    padding: 0.15rem 0.5rem;
    border-radius: 4px;
    background: var(--tag-bg);
    color: var(--text-dim);
    white-space: nowrap;
  }

  .tag-date {
    color: var(--text-muted);
    font-size: 0.72rem;
    font-family: var(--font-mono);
  }

  .tag-metric {
    font-size: 0.72rem;
    font-family: var(--font-mono);
    color: var(--text-muted);
  }

  /* â”€â”€â”€ Keyword Highlights â”€â”€â”€ */
  .keyword-section {
    padding: 1rem 2rem;
    border-bottom: 1px solid var(--border);
  }

  .keyword-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
  }

  .keyword-pill {
    font-size: 0.7rem;
    font-family: var(--font-mono);
    padding: 0.25rem 0.65rem;
    border-radius: 20px;
    background: var(--tag-bg);
    color: var(--text-dim);
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.15s;
  }

  .keyword-pill:hover,
  .keyword-pill.active {
    border-color: var(--text-muted);
    color: var(--text);
  }

  /* â”€â”€â”€ Empty / Loading â”€â”€â”€ */
  .loading, .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-muted);
    font-family: var(--font-mono);
    font-size: 0.85rem;
  }

  .loading::before {
    content: "â—Œ";
    display: block;
    font-size: 2rem;
    margin-bottom: 1rem;
    animation: spin 2s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .empty-state::before {
    content: "âˆ…";
    display: block;
    font-size: 2rem;
    margin-bottom: 1rem;
  }

  /* â”€â”€â”€ Responsive â”€â”€â”€ */
  @media (max-width: 768px) {
    .header { padding: 1rem; flex-wrap: wrap; }
    .main-layout { flex-direction: column; }
    .tab-hamburger-wrap { width: 100%; }
    .tab-dropdown { left: 0; right: 0; }
    .tab.active { border-left-color: transparent; border-bottom-color: var(--text); }
    .content { padding: 1rem; }
    .stats-bar { padding: 0.8rem 1rem; gap: 1.2rem; }
    .search-box { width: 100%; }
    .card { padding: 1rem; }
    .keyword-section { padding: 0.8rem 1rem; }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="logo">Sophia<span>Select</span></div>
    <div class="meta-info" id="meta-info">loading...</div>
  </div>
  <div class="header-right">
    <input type="text" class="search-box" id="search" placeholder="filter by keyword, author, title..." />
    <button class="collection-btn" id="collection-btn" data-category="mycollection">
      ğŸ“Œ My Collection <span class="count" id="count-mycollection">â€”</span>
    </button>
  </div>
</div>

<div class="main-layout">
<div class="tab-hamburger-wrap" id="tabs">
  <button class="tab-hamburger-btn" id="tab-hamburger-btn">
    <span class="hamburger-icon">â˜°</span>
    <span class="hamburger-label" id="hamburger-label">å…¨éƒ¨</span>
    <span class="hamburger-count" id="hamburger-count"></span>
    <span class="hamburger-arrow">â–¾</span>
  </button>
  <div class="tab-dropdown" id="tab-dropdown">
    <button class="tab active" data-category="all">
      å…¨éƒ¨ <span class="count" id="count-all">â€”</span>
    </button>
    <button class="tab" data-category="papers">
      <span class="source-dot" style="background:var(--accent-papers)"></span>
      å­¦æœ¯è®ºæ–‡ <span class="count" id="count-papers">â€”</span>
    </button>
    <button class="tab" data-category="discussions">
      <span class="source-dot" style="background:var(--accent-discussions)"></span>
      ç¤¾åŒºè®¨è®º <span class="count" id="count-discussions">â€”</span>
    </button>
    <button class="tab" data-category="blogs">
      <span class="source-dot" style="background:var(--accent-blogs)"></span>
      å®éªŒå®¤åšå®¢ <span class="count" id="count-blogs">â€”</span>
    </button>
    <button class="tab" data-category="newsletters">
      <span class="source-dot" style="background:var(--accent-newsletters)"></span>
      Newsletter <span class="count" id="count-newsletters">â€”</span>
    </button>
    <button class="tab" data-category="researchers">
      <span class="source-dot" style="background:var(--accent-researchers)"></span>
      æ¨èå…³æ³¨ <span class="count" id="count-researchers">â€”</span>
    </button>
    <button class="tab" data-category="podcasts">
      <span class="source-dot" style="background:var(--accent-podcasts)"></span>
      æ’­å®¢ <span class="count" id="count-podcasts">â€”</span>
    </button>
    <button class="tab" data-category="conferences">
      <span class="source-dot" style="background:var(--accent-conferences)"></span>
      ä¼šè®® <span class="count" id="count-conferences">â€”</span>
    </button>
    <button class="tab" data-category="faculty_jobs">
      <span class="source-dot" style="background:#e91e63"></span>
      ğŸ“ Faculty Jobs <span class="count" id="count-faculty_jobs">â€”</span>
    </button>
    <button class="tab" data-category="opportunities">
      <span class="source-dot" style="background:var(--accent-opportunities)"></span>
      Career/Grants <span class="count" id="count-opportunities">â€”</span>
    </button>
  </div>
</div>

<div class="main-right">
<!-- Hamburger tab is part of main-right now -->
<div class="stats-bar" id="stats-bar">
  <div class="stat">
    <div class="stat-value" id="stat-total">â€”</div>
    <div class="stat-label">Total Fetched</div>
  </div>
  <div class="stat">
    <div class="stat-value" id="stat-papers">â€”</div>
    <div class="stat-label">Papers</div>
  </div>
  <div class="stat">
    <div class="stat-value" id="stat-discussions">â€”</div>
    <div class="stat-label">Discussions</div>
  </div>
  <div class="stat">
    <div class="stat-value" id="stat-links">â€”</div>
    <div class="stat-label">Curated Links</div>
  </div>
  <div class="stat">
    <div class="stat-value" id="stat-window">â€”</div>
    <div class="stat-label">Day Window</div>
  </div>
</div>

<div class="keyword-section" id="keyword-section">
  <div class="keyword-pills" id="keyword-pills"></div>
</div>
<div class="keyword-section" id="region-section" style="display:none">
  <div class="keyword-pills" id="region-pills">
    <span class="keyword-pill" data-region="all">All</span>
    <span class="keyword-pill" data-region="ğŸ›ï¸">ğŸ‡ºğŸ‡¸ US</span>
    <span class="keyword-pill" data-region="ğŸ‡­ğŸ‡°">ğŸ‡­ğŸ‡° Hong Kong</span>
    <span class="keyword-pill" data-region="ğŸ‡¸ğŸ‡¬">ğŸ‡¸ğŸ‡¬ Singapore (All)</span>
    <span class="keyword-pill" data-region="SG Industry">ğŸ¢ SG Industry</span>
    <span class="keyword-pill" data-region="SG Gov">ğŸ›ï¸ SG Gov/Research</span>
    <span class="keyword-pill" data-region="ğŸ‡¦ğŸ‡º">ğŸ‡¦ğŸ‡º Australia</span>
    <span class="keyword-pill" data-region="ğŸ“">ğŸ“ Fellowship</span>
    <span class="keyword-pill" data-region="ğŸ¢">ğŸ¢ University</span>
    <span class="keyword-pill" data-region="ğŸŒ">ğŸŒ International</span>
    <span class="keyword-pill" data-region="ğŸ“‹">ğŸ“‹ Job Board</span>
    <span class="keyword-pill" data-region="Industry AI">ğŸ¤– AI Companies</span>
    <span class="keyword-pill" data-region="AI Research Tools">ğŸ”¬ Research Tools</span>
    <span class="keyword-pill" data-region="Big Tech UX">ğŸ–¥ï¸ Big Tech UX</span>
    <span class="keyword-pill" data-region="Dev Tools">âš¡ Dev Tools</span>
  </div>
</div>
<div class="keyword-section" id="conf-section" style="display:none">
  <div class="keyword-pills" id="conf-field-pills">
    <span class="keyword-pill" data-field="all">All Fields</span>
    <span class="keyword-pill" data-field="HCI">ğŸ–¥ï¸ HCI</span>
    <span class="keyword-pill" data-field="AI-ML">ğŸ¤– AI/ML</span>
    <span class="keyword-pill" data-field="NLP">ğŸ’¬ NLP</span>
    <span class="keyword-pill" data-field="SE">âš™ï¸ SE</span>
    <span class="keyword-pill" data-field="Ethics">âš–ï¸ Ethics</span>
    <span class="keyword-pill" data-field="Workshop">ğŸ”¬ Workshop</span>
  </div>
  <div class="keyword-pills" id="conf-deadline-pills" style="margin-top:0.4rem">
    <span class="keyword-pill" data-deadline="all">All Deadlines</span>
    <span class="keyword-pill" data-deadline="upcoming">â° Upcoming</span>
    <span class="keyword-pill" data-deadline="passed">âœ… Passed</span>
    <span class="keyword-pill" data-deadline="tbd">â“ TBD</span>
    <span class="keyword-pill" data-deadline="happening">ğŸ”´ Happening Soon</span>
  </div>
</div>
<div class="keyword-section" id="source-section" style="display:none">
  <div class="keyword-pills" id="source-pills">
    <span class="keyword-pill" data-source="all">All</span>
    <span class="keyword-pill" data-source="mine">ğŸ“Œ My Additions</span>
    <span class="keyword-pill" data-source="auto">ğŸ“¡ Auto-Fetched</span>
  </div>
</div>

<!-- My Collection Input Form (hidden by default) -->
<div id="collection-form" style="display:none; padding:1rem 2rem; border-bottom:1px solid var(--border); background:var(--surface);">
  <div style="display:flex; flex-direction:column; gap:0.6rem; max-width:640px;">
    <div style="display:flex; gap:0.75rem;">
      <div style="width:140px;">
        <label style="font-size:0.7rem; text-transform:uppercase; letter-spacing:0.05em; color:var(--text-muted); font-family:var(--font-mono); display:block; margin-bottom:0.25rem;">Type</label>
        <select id="col-type" style="width:100%; padding:0.5rem; border:1px solid var(--border); border-radius:6px; font-family:var(--font-sans); font-size:0.85rem; background:var(--bg);">
          <option value="link">ğŸ“ Link / Paper</option>
          <option value="author">ğŸ‘¤ Author</option>
          <option value="note">ğŸ“ Note</option>
          <option value="opportunity">ğŸ’¼ Career/Grant</option>
          <option value="faculty_job">ğŸ“ Faculty Job</option>
        </select>
      </div>
      <div style="width:160px;">
        <label style="font-size:0.7rem; text-transform:uppercase; letter-spacing:0.05em; color:var(--text-muted); font-family:var(--font-mono); display:block; margin-bottom:0.25rem;">Category</label>
        <select id="col-category" style="width:100%; padding:0.5rem; border:1px solid var(--border); border-radius:6px; font-family:var(--font-sans); font-size:0.85rem; background:var(--bg);">
          <option value="mycollection">ğŸ“Œ General</option>
          <option value="papers">ğŸ“„ å­¦æœ¯è®ºæ–‡</option>
          <option value="discussions">ğŸ’¬ ç¤¾åŒºè®¨è®º</option>
          <option value="blogs">ğŸ”¬ å®éªŒå®¤åšå®¢</option>
          <option value="newsletters">ğŸ“° Newsletter</option>
          <option value="researchers">ğŸ‘¤ æ¨èå…³æ³¨</option>
          <option value="podcasts">ğŸ™ï¸ æ’­å®¢</option>
          <option value="conferences">ğŸ›ï¸ ä¼šè®®</option>
          <option value="opportunities">ğŸ’¼ Career/Grants</option>
        </select>
      </div>
      <div style="flex:1;">
        <label style="font-size:0.7rem; text-transform:uppercase; letter-spacing:0.05em; color:var(--text-muted); font-family:var(--font-mono); display:block; margin-bottom:0.25rem;">Title / Name</label>
        <input id="col-title" type="text" placeholder="Paper title, author name, or note..." style="width:100%; padding:0.5rem; border:1px solid var(--border); border-radius:6px; font-family:var(--font-sans); font-size:0.85rem;">
      </div>
    </div>
    <div>
      <label style="font-size:0.7rem; text-transform:uppercase; letter-spacing:0.05em; color:var(--text-muted); font-family:var(--font-mono); display:block; margin-bottom:0.25rem;">URL (optional)</label>
      <input id="col-url" type="text" placeholder="https://..." style="width:100%; padding:0.5rem; border:1px solid var(--border); border-radius:6px; font-family:var(--font-sans); font-size:0.85rem;">
    </div>
    <div>
      <label style="font-size:0.7rem; text-transform:uppercase; letter-spacing:0.05em; color:var(--text-muted); font-family:var(--font-mono); display:block; margin-bottom:0.25rem;">Notes / Description</label>
      <textarea id="col-notes" placeholder="Why is this interesting? Key takeaways..." rows="2" style="width:100%; padding:0.5rem; border:1px solid var(--border); border-radius:6px; font-family:var(--font-sans); font-size:0.85rem; resize:vertical;"></textarea>
    </div>
    <div style="display:flex; gap:0.75rem; align-items:flex-end;">
      <div style="flex:1;">
        <label style="font-size:0.7rem; text-transform:uppercase; letter-spacing:0.05em; color:var(--text-muted); font-family:var(--font-mono); display:block; margin-bottom:0.25rem;">Tags (comma separated)</label>
        <input id="col-tags" type="text" placeholder="HCI, LLM, agent..." style="width:100%; padding:0.5rem; border:1px solid var(--border); border-radius:6px; font-family:var(--font-sans); font-size:0.85rem;">
      </div>
      <button id="col-submit" style="padding:0.5rem 1.5rem; background:#e74c3c; color:white; border:none; border-radius:6px; font-family:var(--font-mono); font-size:0.8rem; cursor:pointer; font-weight:600; white-space:nowrap; height:36px;">+ Add</button>
    </div>
  </div>
</div>

<div class="content" id="content">
  <div class="loading">Fetching data...</div>
</div>
</div><!-- /main-right -->
</div><!-- /main-layout -->

<script>
// â”€â”€â”€ State â”€â”€â”€
let allItems = [];
let staticData = {};
let currentCategory = 'all';
let currentKeyword = '';
let currentRegion = 'all';
let currentSource = 'all';
let currentField = 'all';
let currentDeadline = 'all';
let searchQuery = '';

const sourceColors = {
  arxiv: 'var(--accent-arxiv)',
  semantic_scholar: 'var(--accent-scholar)',
  hackernews: 'var(--accent-hn)',
  reddit: 'var(--accent-reddit)',
};

const sourceLabels = {
  arxiv: 'arXiv',
  semantic_scholar: 'S2',
  hackernews: 'HN',
  reddit: 'Reddit',
  faculty_jobs: 'Faculty',
};

const categoryMeta = {
  papers:      { sources: ['arxiv', 'semantic_scholar'], color: 'var(--accent-papers)' },
  discussions: { sources: ['hackernews', 'reddit'],      color: 'var(--accent-discussions)' },
  blogs:       { static: true, color: 'var(--accent-blogs)',       nameKey: '\u540d\u79f0', urlKey: '\u94fe\u63a5', descKey: '\u8bf4\u660e' },
  newsletters: { static: true, color: 'var(--accent-newsletters)', nameKey: '\u540d\u79f0', urlKey: '\u94fe\u63a5', descKey: '\u8bf4\u660e', extraKey: '\u4f5c\u8005' },
  researchers: { static: true, color: 'var(--accent-researchers)', nameKey: '\u59d3\u540d', urlKey: '\u94fe\u63a5', descKey: '\u8bf4\u660e', extraKey: '\u5e73\u53f0' },
  podcasts:    { static: true, color: 'var(--accent-podcasts)',    nameKey: '\u540d\u79f0', urlKey: '\u94fe\u63a5', descKey: '\u8bf4\u660e' },
  conferences: { static: true, color: 'var(--accent-conferences)', nameKey: '\u540d\u79f0', urlKey: '\u94fe\u63a5', descKey: '\u8bf4\u660e', extraKey: '\u9886\u57df', deadlineKey: 'Deadline', confDateKey: '\u4f1a\u8bae\u65e5\u671f' },
  opportunities: { static: true, color: 'var(--accent-opportunities)', nameKey: '\u540d\u79f0', urlKey: '\u94fe\u63a5', descKey: '\u8bf4\u660e', extraKey: '\u7c7b\u578b' },
  faculty_jobs: { sources: ['faculty_jobs'], color: 'var(--accent-faculty_jobs)' },
};

// â”€â”€â”€ Load Data â”€â”€â”€
async function loadData() {
  try {
    const resp = await fetch('data/latest.json');
    if (!resp.ok) throw new Error('No data yet');
    const data = await resp.json();

    allItems = [
      ...(data.arxiv || []),
      ...(data.semantic_scholar || []),
      ...(data.hackernews || []),
      ...(data.reddit || []),
      ...(data.faculty_jobs || []),
    ];

    staticData = {
      blogs: data.blogs || [],
      newsletters: data.newsletters || [],
      researchers: data.researchers || [],
      podcasts: data.podcasts || [],
      conferences: data.conferences || [],
      opportunities: data.opportunities || [],
    };

    // Update meta
    const fetchedAt = new Date(data.meta?.fetched_at);
    document.getElementById('meta-info').textContent =
      `updated ${fetchedAt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' })}`;

    // Counts
    const paperCount = (data.arxiv || []).length + (data.semantic_scholar || []).length;
    const discussionCount = (data.hackernews || []).length + (data.reddit || []).length;
    const totalLinks = Object.values(staticData).reduce((s, a) => s + a.length, 0);

    document.getElementById('count-all').textContent = allItems.length;
    document.getElementById('count-papers').textContent = paperCount;
    document.getElementById('count-discussions').textContent = discussionCount;
    document.getElementById('count-blogs').textContent = staticData.blogs.length;
    document.getElementById('count-newsletters').textContent = staticData.newsletters.length;
    document.getElementById('count-researchers').textContent = staticData.researchers.length;
    document.getElementById('count-podcasts').textContent = staticData.podcasts.length;
    document.getElementById('count-conferences').textContent = staticData.conferences.length;
    document.getElementById('count-opportunities').textContent = staticData.opportunities.length;
    document.getElementById('count-faculty_jobs').textContent = (data.faculty_jobs || []).length;

    // Stats
    document.getElementById('stat-total').textContent = allItems.length;
    document.getElementById('stat-papers').textContent = paperCount;
    document.getElementById('stat-discussions').textContent = discussionCount;
    document.getElementById('stat-links').textContent = totalLinks;
    document.getElementById('stat-window').textContent = data.meta?.lookback_days || 7;

    buildKeywordPills();
    render();
  } catch (e) {
    document.getElementById('content').innerHTML = `
      <div class="empty-state">
        No data available yet.<br>
        Run the fetch script first, or wait for the next scheduled run.<br>
        <span style="color:var(--text-muted);font-size:0.75rem;margin-top:0.5rem;display:block">
          python scripts/fetch_all.py
        </span>
      </div>`;
  }
}

function buildKeywordPills() {
  const container = document.getElementById('keyword-pills');
  const matched = new Set(allItems.map(i => i.matched_keyword).filter(Boolean));
  const pills = [...matched].sort();

  container.innerHTML = pills.map(kw => `
    <span class="keyword-pill" data-keyword="${kw}">${kw}</span>
  `).join('');

  container.querySelectorAll('.keyword-pill').forEach(pill => {
    pill.addEventListener('click', () => {
      const kw = pill.dataset.keyword;
      if (currentKeyword === kw) {
        currentKeyword = '';
        pill.classList.remove('active');
      } else {
        container.querySelectorAll('.keyword-pill').forEach(p => p.classList.remove('active'));
        currentKeyword = kw;
        pill.classList.add('active');
      }
      render();
    });
  });
}

// â”€â”€â”€ Render â”€â”€â”€
function render() {
  const meta = categoryMeta[currentCategory];
  const container = document.getElementById('content');
  const kwSection = document.getElementById('keyword-section');

  const regionSection = document.getElementById('region-section');
  const sourceSection = document.getElementById('source-section');

  // Show appropriate filter bars
  const isStatic = meta && meta.static;
  const hasUserItems = getCollection().some(i => i.category === currentCategory);
  const confSection = document.getElementById('conf-section');
  // Grid layout for all categories
  container.classList.add('grid-mode');
  kwSection.style.display = (currentCategory === 'papers') ? '' : 'none';
  regionSection.style.display = currentCategory === 'opportunities' ? '' : 'none';
  confSection.style.display = currentCategory === 'conferences' ? '' : 'none';
  sourceSection.style.display = (isStatic && hasUserItems) ? '' : 'none';

  // Static link categories
  if (meta && meta.static) {
    let items = staticData[currentCategory] || [];
    // Region filter for opportunities
    if (currentCategory === 'opportunities' && currentRegion !== 'all') {
      items = items.filter(i => (i['\u7c7b\u578b'] || '').includes(currentRegion));
    }
    // Field + deadline filter for conferences
    if (currentCategory === 'conferences') {
      if (currentField !== 'all') {
        items = items.filter(i => (i['\u9886\u57df'] || '') === currentField);
      }
      if (currentDeadline !== 'all') {
        const now = new Date();
        items = items.filter(i => {
          if (currentDeadline === 'happening') {
            const cd = i['\u4f1a\u8bae\u65e5\u671f'] || '';
            if (!cd || cd === 'TBD') return false;
            const cdDate = new Date(cd);
            const diffDays = Math.ceil((cdDate - now) / 86400000);
            return diffDays >= -3 && diffDays <= 60; // happening within 60 days
          }
          const dl = i['Deadline'] || '';
          if (currentDeadline === 'tbd') return !dl || dl === 'TBD';
          const dlDate = new Date(dl);
          if (isNaN(dlDate)) return currentDeadline === 'tbd';
          return currentDeadline === 'upcoming' ? dlDate >= now : dlDate < now;
        });
      }
    }
    if (searchQuery) {
      const q = searchQuery.toLowerCase();
      items = items.filter(i => Object.values(i).join(' ').toLowerCase().includes(q));
    }
    // User-added items for this category
    let userItems = getCollection().filter(i => i.category === currentCategory);
    if (searchQuery) {
      const q = searchQuery.toLowerCase();
      userItems = userItems.filter(i => [i.title, i.url, i.notes, i.tags].join(' ').toLowerCase().includes(q));
    }
    userItems.sort((a,b) => (b.addedAt||0) - (a.addedAt||0));

    const renderUserCard = (item) => {
      const typeIcon = item.type === 'author' ? 'ğŸ‘¤' : item.type === 'note' ? 'ğŸ“' : item.type === 'opportunity' ? 'ğŸ’¼' : 'ğŸ“';
      const titleHtml = item.url ? `<a href="${escapeHtml(item.url)}" target="_blank">${escapeHtml(item.title)}</a>` : escapeHtml(item.title);
      const tags = item.tags ? item.tags.split(',').map(t => t.trim()).filter(Boolean).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('') : '';
      return `<div class="card"><div class="card-header"><div class="card-source-indicator" style="background:#e74c3c"></div><div style="flex:1"><div class="card-title" style="display:flex;justify-content:space-between;align-items:center">${titleHtml}<button class="remove-collection-btn" data-added-at="${item.addedAt}" style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:0.9rem;padding:2px 6px;border-radius:4px;opacity:0.5;transition:opacity 0.15s" onmouseover="this.style.opacity=1;this.style.color='#e74c3c'" onmouseout="this.style.opacity=0.5;this.style.color='var(--text-muted)'" title="Remove">âœ•</button></div>${item.notes ? `<div class="card-summary">${escapeHtml(item.notes)}</div>` : ''}<div class="card-meta"><span class="tag" style="border-left:2px solid #e74c3c;padding-left:0.5rem">${typeIcon} My Addition</span>${tags}</div></div></div></div>`;
    };

    // Apply source filter
    const showMine = currentSource === 'all' || currentSource === 'mine';
    const showAuto = currentSource === 'all' || currentSource === 'auto';

    const userHtml = (showMine && userItems.length > 0) ? userItems.map(renderUserCard).join('') : '';
    const autoHtml = showAuto ? items.map(item => renderLinkCard(item, meta)).join('') : '';

    if (!userHtml && !autoHtml) {
      container.innerHTML = '<div class="empty-state">No items match your filters.</div>';
      return;
    }

    let html = '';
    if (userHtml && autoHtml) {
      html = '<div class="grid-section-header" style="margin-bottom:0.5rem;font-size:0.7rem;color:var(--text-muted);font-family:var(--font-mono);padding:0 0.5rem;">ğŸ“Œ MY ADDITIONS</div>' + userHtml + '<div class="grid-section-header" style="margin:1rem 0 0.5rem;font-size:0.7rem;color:var(--text-muted);font-family:var(--font-mono);padding:0 0.5rem;">ğŸ“¡ AUTO-FETCHED</div>' + autoHtml;
    } else {
      html = userHtml || autoHtml;
    }
    container.innerHTML = html;
    return;
  }

  // Fetched data categories
  let items = allItems;

  if (meta && meta.sources) {
    items = items.filter(i => meta.sources.includes(i.source));
  }

  if (currentKeyword) {
    items = items.filter(i => i.matched_keyword === currentKeyword);
  }

  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    items = items.filter(i => {
      const searchable = [
        i.title, i.matched_keyword,
        ...(i.authors || []),
        i.summary || '',
        i.subreddit || '',
      ].join(' ').toLowerCase();
      return searchable.includes(q);
    });
  }

  if (items.length === 0) {
    container.innerHTML = '<div class="empty-state">No items match your filters.</div>';
    return;
  }

  container.innerHTML = items.map(renderCard).join('');
}

function renderCard(item) {
  const color = sourceColors[item.source] || 'var(--text-muted)';
  const label = sourceLabels[item.source] || item.source;

  let authors = '';
  if (item.authors?.length) {
    authors = `<div class="card-authors">${item.authors.join(', ')}</div>`;
  }

  let summary = '';
  if (item.summary) {
    summary = `<div class="card-summary">${escapeHtml(item.summary)}</div>`;
  }

  let metrics = '';
  if (item.source === 'hackernews') {
    metrics = `
      <span class="tag-metric">\u25B2 ${item.points || 0}</span>
      <span class="tag-metric">\uD83D\uDCAC ${item.comments || 0}</span>
    `;
  } else if (item.source === 'reddit') {
    metrics = `
      <span class="tag-metric">\u25B2 ${item.score || 0}</span>
      <span class="tag-metric">\uD83D\uDCAC ${item.comments || 0}</span>
      <span class="tag">r/${item.subreddit}</span>
    `;
  } else if (item.citations != null && item.citations > 0) {
    metrics = `<span class="tag-metric">\uD83D\uDCD1 ${item.citations} cites</span>`;
  }

  let categories = '';
  if (item.categories?.length) {
    categories = item.categories.slice(0, 3).map(c =>
      `<span class="tag">${c}</span>`
    ).join('');
  }

  return `
    <div class="card">
      <div class="card-header">
        <div class="card-source-indicator" style="background:${color}"></div>
        <div style="flex:1">
          <div class="card-title">
            <a href="${escapeHtml(item.link)}" target="_blank" rel="noopener">${escapeHtml(item.title)}</a>
          </div>
          ${authors}
          ${summary}
          <div class="card-meta">
            <span class="tag" style="border-left:2px solid ${color};padding-left:0.5rem">${label}</span>
            <span class="tag-date">${item.published || ''}</span>
            <span class="tag">${escapeHtml(item.matched_keyword || '')}</span>
            ${metrics}
            ${categories}
            ${item.hn_link ? `<a href="${item.hn_link}" target="_blank" style="font-size:0.7rem;color:var(--accent-hn);text-decoration:none;font-family:var(--font-mono)">hn\u2197</a>` : ''}
          </div>
        </div>
      </div>
    </div>`;
}

function renderLinkCard(item, meta) {
  const color = meta.color;
  const name = item[meta.nameKey] || '';
  const url = meta.urlKey ? item[meta.urlKey] || '' : '';
  const desc = item[meta.descKey] || '';
  const extra = meta.extraKey ? item[meta.extraKey] || '' : '';

  // Conference date badge
  let confDateBadge = '';
  if (meta.confDateKey && item[meta.confDateKey] && item[meta.confDateKey] !== 'TBD') {
    const cd = new Date(item[meta.confDateKey]);
    const now = new Date();
    const diffDays = Math.ceil((cd - now) / 86400000);
    const dateStr = item[meta.confDateKey];
    if (diffDays >= -3 && diffDays <= 0) {
      confDateBadge = `<span class="tag" style="color:#e74c3c;font-weight:600">ğŸ”´ NOW! ${dateStr}</span>`;
    } else if (diffDays > 0 && diffDays <= 30) {
      confDateBadge = `<span class="tag" style="color:#e67e22;font-weight:600">ğŸŸ  ${dateStr} (in ${diffDays}d)</span>`;
    } else if (diffDays > 0) {
      confDateBadge = `<span class="tag" style="color:#2980b9">ğŸ“† ${dateStr}</span>`;
    }
  }

  // Deadline badge for conferences
  let deadlineBadge = '';
  if (meta.deadlineKey && item[meta.deadlineKey]) {
    const dl = item[meta.deadlineKey];
    if (dl === 'TBD') {
      deadlineBadge = '<span class="tag" style="color:#999">â“ TBD</span>';
    } else {
      const dlDate = new Date(dl);
      const now = new Date();
      const diffDays = Math.ceil((dlDate - now) / 86400000);
      if (diffDays < 0) {
        deadlineBadge = `<span class="tag" style="color:#999;text-decoration:line-through">ğŸ“… ${dl}</span>`;
      } else if (diffDays <= 30) {
        deadlineBadge = `<span class="tag" style="color:#e74c3c;font-weight:600">â° ${dl} (${diffDays}d left!)</span>`;
      } else {
        deadlineBadge = `<span class="tag" style="color:#27ae60">ğŸ“… ${dl} (${diffDays}d)</span>`;
      }
    }
  }

  const titleHtml = url
    ? `<a href="${escapeHtml(url)}" target="_blank" rel="noopener">${escapeHtml(name)}</a>`
    : escapeHtml(name);

  return `
    <div class="card">
      <div class="card-header">
        <div class="card-source-indicator" style="background:${color}"></div>
        <div style="flex:1">
          <div class="card-title">${titleHtml}</div>
          <div class="card-meta" style="margin-top:0.3rem">
            ${extra ? `<span class="tag">${escapeHtml(extra)}</span>` : ''}
            ${confDateBadge}
            ${deadlineBadge}
          </div>
          ${desc ? `<div class="card-summary">${escapeHtml(desc)}</div>` : ''}
        </div>
      </div>
    </div>`;
}

function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€â”€ Hamburger Tab Menu â”€â”€â”€
const hamburgerBtn = document.getElementById('tab-hamburger-btn');
const tabDropdown = document.getElementById('tab-dropdown');
const hamburgerLabel = document.getElementById('hamburger-label');
const hamburgerCount = document.getElementById('hamburger-count');

function updateHamburgerLabel() {
  const activeTab = document.querySelector('.tab.active');
  if (activeTab) {
    // Get text without count
    const clone = activeTab.cloneNode(true);
    const countEl = clone.querySelector('.count');
    const countText = countEl ? countEl.textContent : '';
    if (countEl) countEl.remove();
    hamburgerLabel.textContent = clone.textContent.trim();
    hamburgerCount.textContent = countText;
  }
}

hamburgerBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  tabDropdown.classList.toggle('open');
});

// Close dropdown on outside click
document.addEventListener('click', () => {
  tabDropdown.classList.remove('open');
});

// â”€â”€â”€ Events â”€â”€â”€
document.getElementById('tabs').addEventListener('click', e => {
  const tab = e.target.closest('.tab');
  if (!tab) return;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  tab.classList.add('active');
  currentCategory = tab.dataset.category;
  // Close dropdown and update label
  tabDropdown.classList.remove('open');
  updateHamburgerLabel();
  // Clear filters when switching tabs
  currentKeyword = '';
  currentRegion = 'all';
  currentSource = 'all';
  currentField = 'all';
  currentDeadline = 'all';
  document.querySelectorAll('.keyword-pill').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('#region-pills .keyword-pill').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('#source-pills .keyword-pill').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('#conf-field-pills .keyword-pill').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('#conf-deadline-pills .keyword-pill').forEach(p => p.classList.remove('active'));
  render();
});

// Initialize hamburger label
updateHamburgerLabel();

document.getElementById('search').addEventListener('input', e => {
  searchQuery = e.target.value;
  render();
});

document.addEventListener('keydown', e => {
  if (e.key === '/' && document.activeElement !== document.getElementById('search')) {
    e.preventDefault();
    document.getElementById('search').focus();
  }
  if (e.key === 'Escape') {
    document.getElementById('search').blur();
    document.getElementById('search').value = '';
    searchQuery = '';
    render();
  }
});

// â”€â”€â”€ Region Filter (opportunities) â”€â”€â”€
document.getElementById('region-pills').addEventListener('click', e => {
  const pill = e.target.closest('.keyword-pill');
  if (!pill) return;
  const region = pill.dataset.region;
  currentRegion = region;
  document.querySelectorAll('#region-pills .keyword-pill').forEach(p => p.classList.remove('active'));
  if (region !== 'all') pill.classList.add('active');
  render();
});

// â”€â”€â”€ Remove Collection Item (delegated) â”€â”€â”€
document.getElementById('content').addEventListener('click', e => {
  const btn = e.target.closest('.remove-collection-btn');
  if (!btn) return;
  const addedAt = Number(btn.dataset.addedAt);
  if (!confirm('Remove this item?')) return;
  const items = getCollection().filter(i => i.addedAt !== addedAt);
  saveCollection(items);
  render();
});

// â”€â”€â”€ Conference Filters (field + deadline) â”€â”€â”€
document.getElementById('conf-field-pills').addEventListener('click', e => {
  const pill = e.target.closest('.keyword-pill');
  if (!pill) return;
  currentField = pill.dataset.field;
  document.querySelectorAll('#conf-field-pills .keyword-pill').forEach(p => p.classList.remove('active'));
  if (currentField !== 'all') pill.classList.add('active');
  render();
});
document.getElementById('conf-deadline-pills').addEventListener('click', e => {
  const pill = e.target.closest('.keyword-pill');
  if (!pill) return;
  currentDeadline = pill.dataset.deadline;
  document.querySelectorAll('#conf-deadline-pills .keyword-pill').forEach(p => p.classList.remove('active'));
  if (currentDeadline !== 'all') pill.classList.add('active');
  render();
});

// â”€â”€â”€ Source Filter (My Additions vs Auto-Fetched) â”€â”€â”€
document.getElementById('source-pills').addEventListener('click', e => {
  const pill = e.target.closest('.keyword-pill');
  if (!pill) return;
  currentSource = pill.dataset.source;
  document.querySelectorAll('#source-pills .keyword-pill').forEach(p => p.classList.remove('active'));
  if (currentSource !== 'all') pill.classList.add('active');
  render();
});

// â”€â”€â”€ My Collection (localStorage) â”€â”€â”€
const COLLECTION_KEY = 'sophia-select-collection';

function getCollection() {
  try { return JSON.parse(localStorage.getItem(COLLECTION_KEY) || '[]'); } catch { return []; }
}

function saveCollection(items) {
  localStorage.setItem(COLLECTION_KEY, JSON.stringify(items));
  document.getElementById('count-mycollection').textContent = items.length;
}

function renderCollection(filterCategory) {
  const container = document.getElementById('content');
  const form = document.getElementById('collection-form');
  form.style.display = currentCategory === 'mycollection' ? '' : 'none';
  
  let items = getCollection();
  // Filter by category if viewing a specific tab
  if (filterCategory) {
    items = items.filter(i => i.category === filterCategory);
  } else {
    // In "My Collection" tab, show all or filter to general-only
    // Show all items
  }
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    items = items.filter(i => [i.title, i.url, i.notes, i.tags, i.type, i.category].join(' ').toLowerCase().includes(q));
  }

  if (items.length === 0) {
    container.innerHTML = '<div class="empty-state">No items yet. Use the form above to add links, authors, or notes.</div>';
    return;
  }

  // Sort newest first
  items.sort((a, b) => (b.addedAt || 0) - (a.addedAt || 0));

  container.innerHTML = items.map((item, idx) => {
    const typeIcon = item.type === 'author' ? 'ğŸ‘¤' : item.type === 'note' ? 'ğŸ“' : 'ğŸ“';
    const typeLabel = item.type === 'author' ? 'Author' : item.type === 'note' ? 'Note' : 'Link';
    const titleHtml = item.url
      ? `<a href="${escapeHtml(item.url)}" target="_blank" rel="noopener">${escapeHtml(item.title)}</a>`
      : escapeHtml(item.title);
    const tags = item.tags ? item.tags.split(',').map(t => t.trim()).filter(Boolean).map(t =>
      `<span class="tag">${escapeHtml(t)}</span>`
    ).join('') : '';
    const date = item.addedAt ? new Date(item.addedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';

    return `
      <div class="card">
        <div class="card-header">
          <div class="card-source-indicator" style="background:#e74c3c"></div>
          <div style="flex:1">
            <div class="card-title">${titleHtml}</div>
            ${item.notes ? `<div class="card-summary">${escapeHtml(item.notes)}</div>` : ''}
            <div class="card-meta">
              <span class="tag" style="border-left:2px solid #e74c3c;padding-left:0.5rem">${typeIcon} ${typeLabel}</span>
              <span class="tag-date">${date}</span>
              ${tags}
              <button onclick="deleteCollectionItem(${idx})" style="background:none;border:none;cursor:pointer;font-size:0.7rem;color:var(--text-muted);font-family:var(--font-mono);margin-left:auto;">âœ• remove</button>
            </div>
          </div>
        </div>
      </div>`;
  }).join('');
}

function deleteCollectionItem(idx) {
  const items = getCollection();
  items.splice(idx, 1);
  saveCollection(items);
  renderCollection();
}

// Form submit
document.getElementById('col-submit').addEventListener('click', () => {
  const title = document.getElementById('col-title').value.trim();
  if (!title) { document.getElementById('col-title').focus(); return; }

  const items = getCollection();
  items.push({
    type: document.getElementById('col-type').value,
    category: document.getElementById('col-category').value,
    title,
    url: document.getElementById('col-url').value.trim(),
    notes: document.getElementById('col-notes').value.trim(),
    tags: document.getElementById('col-tags').value.trim(),
    addedAt: Date.now(),
  });
  saveCollection(items);

  // Clear form
  document.getElementById('col-title').value = '';
  document.getElementById('col-url').value = '';
  document.getElementById('col-notes').value = '';
  document.getElementById('col-tags').value = '';

  renderCollection();
});

// Patch render to handle mycollection
const _originalRender = render;
render = function() {
  const form = document.getElementById('collection-form');
  if (currentCategory === 'mycollection') {
    form.style.display = '';
    document.getElementById('content').classList.add('grid-mode');
    renderCollection();
    return;
  }
  form.style.display = 'none';
  _originalRender();
};

// Init collection count
document.getElementById('count-mycollection').textContent = getCollection().length;

// Collection button in header
document.getElementById('collection-btn').addEventListener('click', () => {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('collection-btn').style.opacity = '1';
  currentCategory = 'mycollection';
  currentKeyword = '';
  document.querySelectorAll('.keyword-pill').forEach(p => p.classList.remove('active'));
  render();
});

// â”€â”€â”€ Tab View Tracking (GoatCounter) â”€â”€â”€
// Track tab switches as virtual page views
function trackPageView(category) {
  if (window.goatcounter && window.goatcounter.count) {
    window.goatcounter.count({ path: '/' + category, title: 'Sophia Select - ' + category });
  }
}

// Patch tab click to track views
const _origTabClick = document.getElementById('tabs').onclick;
document.getElementById('tabs').addEventListener('click', () => {
  setTimeout(() => trackPageView(currentCategory), 100);
});
document.getElementById('collection-btn').addEventListener('click', () => {
  setTimeout(() => trackPageView('mycollection'), 100);
});

// â”€â”€â”€ Init â”€â”€â”€
loadData();
</script>

<!-- GoatCounter Analytics (free, privacy-friendly, no cookies) -->
<!-- TODO: Replace YOURCODE with your GoatCounter code after signup at goatcounter.com -->
<script data-goatcounter="https://YOURCODE.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
