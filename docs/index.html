<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Research Radar</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle cx='16' cy='16' r='14' fill='%23d63031' opacity='.15'/><circle cx='16' cy='16' r='9' fill='none' stroke='%23d63031' stroke-width='1.5' opacity='.4'/><circle cx='16' cy='16' r='4.5' fill='none' stroke='%23d63031' stroke-width='1.5' opacity='.7'/><line x1='16' y1='16' x2='16' y2='2' stroke='%23d63031' stroke-width='2' stroke-linecap='round'/><circle cx='16' cy='5' r='2' fill='%23d63031'/></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #ffffff;
    --surface: #f8f9fa;
    --surface-hover: #f0f1f3;
    --border: #e0e0e6;
    --text: #1a1a2e;
    --text-dim: #555570;
    --text-muted: #888899;
    --accent-arxiv: #d63031;
    --accent-scholar: #2980b9;
    --accent-hn: #e65100;
    --accent-reddit: #e53935;
    --accent-twitter: #1a8cd8;
    --accent-papers: #8e44ad;
    --accent-discussions: #e67e22;
    --accent-blogs: #27ae60;
    --accent-newsletters: #2980b9;
    --accent-researchers: #e91e63;
    --accent-podcasts: #ff9800;
    --accent-conferences: #00897b;
    --tag-bg: rgba(0,0,0,0.04);
    --font-mono: 'IBM Plex Mono', monospace;
    --font-sans: 'IBM Plex Sans', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-sans);
    line-height: 1.6;
    min-height: 100vh;
  }

  /* ─── Header ─── */
  .header {
    border-bottom: 1px solid var(--border);
    padding: 1.5rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .logo {
    font-family: var(--font-mono);
    font-size: 1.1rem;
    font-weight: 600;
    letter-spacing: -0.02em;
    color: var(--text);
  }

  .logo span {
    color: var(--accent-arxiv);
  }

  .meta-info {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-family: var(--font-mono);
  }

  .header-right {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  /* ─── Search ─── */
  .search-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.4rem 0.8rem;
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 0.8rem;
    width: 260px;
    outline: none;
    transition: border-color 0.2s;
  }

  .search-box:focus {
    border-color: var(--text-muted);
  }

  .search-box::placeholder {
    color: var(--text-muted);
  }

  /* ─── Tabs / Source Filter ─── */
  .tabs {
    display: flex;
    gap: 0;
    border-bottom: 1px solid var(--border);
    padding: 0 2rem;
    overflow-x: auto;
  }

  .tab {
    padding: 0.7rem 1.2rem;
    font-size: 0.8rem;
    font-family: var(--font-mono);
    color: var(--text-muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: none;
    border-top: none;
    border-left: none;
    border-right: none;
  }

  .tab:hover { color: var(--text-dim); }

  .tab.active {
    color: var(--text);
    border-bottom-color: var(--text);
  }

  .tab .count {
    background: var(--tag-bg);
    padding: 0.1rem 0.45rem;
    border-radius: 10px;
    font-size: 0.7rem;
    color: var(--text-dim);
  }

  .tab.active .count {
    color: var(--text);
  }

  .source-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    display: inline-block;
  }

  /* ─── Stats Bar ─── */
  .stats-bar {
    display: flex;
    gap: 2rem;
    padding: 1rem 2rem;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
  }

  .stat {
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
  }

  .stat-value {
    font-family: var(--font-mono);
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--text);
  }

  .stat-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* ─── Content ─── */
  .content {
    max-width: 1100px;
    margin: 0 auto;
    padding: 1.5rem 2rem;
  }

  /* ─── Card ─── */
  .card {
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.2rem 1.4rem;
    margin-bottom: 0.75rem;
    background: var(--surface);
    transition: background 0.15s, border-color 0.15s;
    cursor: default;
  }

  .card:hover {
    background: var(--surface-hover);
    border-color: #c8c8d0;
  }

  .card-header {
    display: flex;
    align-items: flex-start;
    gap: 0.8rem;
    margin-bottom: 0.5rem;
  }

  .card-source-indicator {
    width: 3px;
    min-height: 1.2rem;
    border-radius: 2px;
    flex-shrink: 0;
    margin-top: 0.25rem;
  }

  .card-title {
    font-size: 0.95rem;
    font-weight: 500;
    line-height: 1.45;
    color: var(--text);
  }

  .card-title a {
    color: inherit;
    text-decoration: none;
  }

  .card-title a:hover {
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .card-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
    align-items: center;
  }

  .card-authors {
    font-size: 0.78rem;
    color: var(--text-dim);
    margin-top: 0.3rem;
    padding-left: 0.7rem;
  }

  .card-summary {
    font-size: 0.82rem;
    color: var(--text-dim);
    line-height: 1.55;
    margin-top: 0.5rem;
    padding-left: 0.7rem;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .tag {
    font-size: 0.68rem;
    font-family: var(--font-mono);
    padding: 0.15rem 0.5rem;
    border-radius: 4px;
    background: var(--tag-bg);
    color: var(--text-dim);
    white-space: nowrap;
  }

  .tag-date {
    color: var(--text-muted);
    font-size: 0.72rem;
    font-family: var(--font-mono);
  }

  .tag-metric {
    font-size: 0.72rem;
    font-family: var(--font-mono);
    color: var(--text-muted);
  }

  /* ─── Keyword Highlights ─── */
  .keyword-section {
    padding: 1rem 2rem;
    border-bottom: 1px solid var(--border);
  }

  .keyword-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
  }

  .keyword-pill {
    font-size: 0.7rem;
    font-family: var(--font-mono);
    padding: 0.25rem 0.65rem;
    border-radius: 20px;
    background: var(--tag-bg);
    color: var(--text-dim);
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.15s;
  }

  .keyword-pill:hover,
  .keyword-pill.active {
    border-color: var(--text-muted);
    color: var(--text);
  }

  /* ─── Empty / Loading ─── */
  .loading, .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-muted);
    font-family: var(--font-mono);
    font-size: 0.85rem;
  }

  .loading::before {
    content: "◌";
    display: block;
    font-size: 2rem;
    margin-bottom: 1rem;
    animation: spin 2s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .empty-state::before {
    content: "∅";
    display: block;
    font-size: 2rem;
    margin-bottom: 1rem;
  }

  /* ─── Responsive ─── */
  @media (max-width: 768px) {
    .header { padding: 1rem; }
    .tabs { padding: 0 1rem; }
    .content { padding: 1rem; }
    .stats-bar { padding: 0.8rem 1rem; gap: 1.2rem; }
    .search-box { width: 100%; }
    .card { padding: 1rem; }
    .keyword-section { padding: 0.8rem 1rem; }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="logo">research<span>/</span>radar</div>
    <div class="meta-info" id="meta-info">loading...</div>
  </div>
  <div class="header-right">
    <input type="text" class="search-box" id="search" placeholder="filter by keyword, author, title..." />
  </div>
</div>

<div class="tabs" id="tabs">
  <button class="tab active" data-category="all">
    全部 <span class="count" id="count-all">—</span>
  </button>
  <button class="tab" data-category="papers">
    <span class="source-dot" style="background:var(--accent-papers)"></span>
    学术论文 <span class="count" id="count-papers">—</span>
  </button>
  <button class="tab" data-category="discussions">
    <span class="source-dot" style="background:var(--accent-discussions)"></span>
    社区讨论 <span class="count" id="count-discussions">—</span>
  </button>
  <button class="tab" data-category="blogs">
    <span class="source-dot" style="background:var(--accent-blogs)"></span>
    实验室博客 <span class="count" id="count-blogs">—</span>
  </button>
  <button class="tab" data-category="newsletters">
    <span class="source-dot" style="background:var(--accent-newsletters)"></span>
    Newsletter <span class="count" id="count-newsletters">—</span>
  </button>
  <button class="tab" data-category="researchers">
    <span class="source-dot" style="background:var(--accent-researchers)"></span>
    推荐关注 <span class="count" id="count-researchers">—</span>
  </button>
  <button class="tab" data-category="podcasts">
    <span class="source-dot" style="background:var(--accent-podcasts)"></span>
    播客 <span class="count" id="count-podcasts">—</span>
  </button>
  <button class="tab" data-category="conferences">
    <span class="source-dot" style="background:var(--accent-conferences)"></span>
    会议 <span class="count" id="count-conferences">—</span>
  </button>
</div>

<div class="stats-bar" id="stats-bar">
  <div class="stat">
    <div class="stat-value" id="stat-total">—</div>
    <div class="stat-label">Total Fetched</div>
  </div>
  <div class="stat">
    <div class="stat-value" id="stat-papers">—</div>
    <div class="stat-label">Papers</div>
  </div>
  <div class="stat">
    <div class="stat-value" id="stat-discussions">—</div>
    <div class="stat-label">Discussions</div>
  </div>
  <div class="stat">
    <div class="stat-value" id="stat-links">—</div>
    <div class="stat-label">Curated Links</div>
  </div>
  <div class="stat">
    <div class="stat-value" id="stat-window">—</div>
    <div class="stat-label">Day Window</div>
  </div>
</div>

<div class="keyword-section" id="keyword-section">
  <div class="keyword-pills" id="keyword-pills"></div>
</div>

<div class="content" id="content">
  <div class="loading">Fetching data...</div>
</div>

<script>
// ─── State ───
let allItems = [];
let staticData = {};
let currentCategory = 'all';
let currentKeyword = '';
let searchQuery = '';

const sourceColors = {
  arxiv: 'var(--accent-arxiv)',
  semantic_scholar: 'var(--accent-scholar)',
  hackernews: 'var(--accent-hn)',
  reddit: 'var(--accent-reddit)',
};

const sourceLabels = {
  arxiv: 'arXiv',
  semantic_scholar: 'S2',
  hackernews: 'HN',
  reddit: 'Reddit',
};

const categoryMeta = {
  papers:      { sources: ['arxiv', 'semantic_scholar'], color: 'var(--accent-papers)' },
  discussions: { sources: ['hackernews', 'reddit'],      color: 'var(--accent-discussions)' },
  blogs:       { static: true, color: 'var(--accent-blogs)',       nameKey: '\u540d\u79f0', urlKey: '\u94fe\u63a5', descKey: '\u8bf4\u660e' },
  newsletters: { static: true, color: 'var(--accent-newsletters)', nameKey: '\u540d\u79f0', urlKey: '\u94fe\u63a5', descKey: '\u8bf4\u660e', extraKey: '\u4f5c\u8005' },
  researchers: { static: true, color: 'var(--accent-researchers)', nameKey: '\u59d3\u540d', urlKey: '\u94fe\u63a5', descKey: '\u8bf4\u660e', extraKey: '\u5e73\u53f0' },
  podcasts:    { static: true, color: 'var(--accent-podcasts)',    nameKey: '\u540d\u79f0', urlKey: '\u94fe\u63a5', descKey: '\u8bf4\u660e' },
  conferences: { static: true, color: 'var(--accent-conferences)', nameKey: '\u540d\u79f0', urlKey: '\u94fe\u63a5', descKey: '\u8bf4\u660e', extraKey: '\u9891\u7387' },
};

// ─── Load Data ───
async function loadData() {
  try {
    const resp = await fetch('data/latest.json');
    if (!resp.ok) throw new Error('No data yet');
    const data = await resp.json();

    allItems = [
      ...(data.arxiv || []),
      ...(data.semantic_scholar || []),
      ...(data.hackernews || []),
      ...(data.reddit || []),
    ];

    staticData = {
      blogs: data.blogs || [],
      newsletters: data.newsletters || [],
      researchers: data.researchers || [],
      podcasts: data.podcasts || [],
      conferences: data.conferences || [],
    };

    // Update meta
    const fetchedAt = new Date(data.meta?.fetched_at);
    document.getElementById('meta-info').textContent =
      `updated ${fetchedAt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' })}`;

    // Counts
    const paperCount = (data.arxiv || []).length + (data.semantic_scholar || []).length;
    const discussionCount = (data.hackernews || []).length + (data.reddit || []).length;
    const totalLinks = Object.values(staticData).reduce((s, a) => s + a.length, 0);

    document.getElementById('count-all').textContent = allItems.length;
    document.getElementById('count-papers').textContent = paperCount;
    document.getElementById('count-discussions').textContent = discussionCount;
    document.getElementById('count-blogs').textContent = staticData.blogs.length;
    document.getElementById('count-newsletters').textContent = staticData.newsletters.length;
    document.getElementById('count-researchers').textContent = staticData.researchers.length;
    document.getElementById('count-podcasts').textContent = staticData.podcasts.length;
    document.getElementById('count-conferences').textContent = staticData.conferences.length;

    // Stats
    document.getElementById('stat-total').textContent = allItems.length;
    document.getElementById('stat-papers').textContent = paperCount;
    document.getElementById('stat-discussions').textContent = discussionCount;
    document.getElementById('stat-links').textContent = totalLinks;
    document.getElementById('stat-window').textContent = data.meta?.lookback_days || 7;

    buildKeywordPills();
    render();
  } catch (e) {
    document.getElementById('content').innerHTML = `
      <div class="empty-state">
        No data available yet.<br>
        Run the fetch script first, or wait for the next scheduled run.<br>
        <span style="color:var(--text-muted);font-size:0.75rem;margin-top:0.5rem;display:block">
          python scripts/fetch_all.py
        </span>
      </div>`;
  }
}

function buildKeywordPills() {
  const container = document.getElementById('keyword-pills');
  const matched = new Set(allItems.map(i => i.matched_keyword).filter(Boolean));
  const pills = [...matched].sort();

  container.innerHTML = pills.map(kw => `
    <span class="keyword-pill" data-keyword="${kw}">${kw}</span>
  `).join('');

  container.querySelectorAll('.keyword-pill').forEach(pill => {
    pill.addEventListener('click', () => {
      const kw = pill.dataset.keyword;
      if (currentKeyword === kw) {
        currentKeyword = '';
        pill.classList.remove('active');
      } else {
        container.querySelectorAll('.keyword-pill').forEach(p => p.classList.remove('active'));
        currentKeyword = kw;
        pill.classList.add('active');
      }
      render();
    });
  });
}

// ─── Render ───
function render() {
  const meta = categoryMeta[currentCategory];
  const container = document.getElementById('content');
  const kwSection = document.getElementById('keyword-section');

  // Show keyword pills only for fetched-data categories
  if (meta && meta.static) {
    kwSection.style.display = 'none';
  } else {
    kwSection.style.display = '';
  }

  // Static link categories
  if (meta && meta.static) {
    let items = staticData[currentCategory] || [];
    if (searchQuery) {
      const q = searchQuery.toLowerCase();
      items = items.filter(i => Object.values(i).join(' ').toLowerCase().includes(q));
    }
    if (items.length === 0) {
      container.innerHTML = '<div class="empty-state">No items match your filters.</div>';
      return;
    }
    container.innerHTML = items.map(item => renderLinkCard(item, meta)).join('');
    return;
  }

  // Fetched data categories
  let items = allItems;

  if (meta && meta.sources) {
    items = items.filter(i => meta.sources.includes(i.source));
  }

  if (currentKeyword) {
    items = items.filter(i => i.matched_keyword === currentKeyword);
  }

  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    items = items.filter(i => {
      const searchable = [
        i.title, i.matched_keyword,
        ...(i.authors || []),
        i.summary || '',
        i.subreddit || '',
      ].join(' ').toLowerCase();
      return searchable.includes(q);
    });
  }

  if (items.length === 0) {
    container.innerHTML = '<div class="empty-state">No items match your filters.</div>';
    return;
  }

  container.innerHTML = items.map(renderCard).join('');
}

function renderCard(item) {
  const color = sourceColors[item.source] || 'var(--text-muted)';
  const label = sourceLabels[item.source] || item.source;

  let authors = '';
  if (item.authors?.length) {
    authors = `<div class="card-authors">${item.authors.join(', ')}</div>`;
  }

  let summary = '';
  if (item.summary) {
    summary = `<div class="card-summary">${escapeHtml(item.summary)}</div>`;
  }

  let metrics = '';
  if (item.source === 'hackernews') {
    metrics = `
      <span class="tag-metric">\u25B2 ${item.points || 0}</span>
      <span class="tag-metric">\uD83D\uDCAC ${item.comments || 0}</span>
    `;
  } else if (item.source === 'reddit') {
    metrics = `
      <span class="tag-metric">\u25B2 ${item.score || 0}</span>
      <span class="tag-metric">\uD83D\uDCAC ${item.comments || 0}</span>
      <span class="tag">r/${item.subreddit}</span>
    `;
  } else if (item.citations != null && item.citations > 0) {
    metrics = `<span class="tag-metric">\uD83D\uDCD1 ${item.citations} cites</span>`;
  }

  let categories = '';
  if (item.categories?.length) {
    categories = item.categories.slice(0, 3).map(c =>
      `<span class="tag">${c}</span>`
    ).join('');
  }

  return `
    <div class="card">
      <div class="card-header">
        <div class="card-source-indicator" style="background:${color}"></div>
        <div style="flex:1">
          <div class="card-title">
            <a href="${escapeHtml(item.link)}" target="_blank" rel="noopener">${escapeHtml(item.title)}</a>
          </div>
          ${authors}
          ${summary}
          <div class="card-meta">
            <span class="tag" style="border-left:2px solid ${color};padding-left:0.5rem">${label}</span>
            <span class="tag-date">${item.published || ''}</span>
            <span class="tag">${escapeHtml(item.matched_keyword || '')}</span>
            ${metrics}
            ${categories}
            ${item.hn_link ? `<a href="${item.hn_link}" target="_blank" style="font-size:0.7rem;color:var(--accent-hn);text-decoration:none;font-family:var(--font-mono)">hn\u2197</a>` : ''}
          </div>
        </div>
      </div>
    </div>`;
}

function renderLinkCard(item, meta) {
  const color = meta.color;
  const name = item[meta.nameKey] || '';
  const url = meta.urlKey ? item[meta.urlKey] || '' : '';
  const desc = item[meta.descKey] || '';
  const extra = meta.extraKey ? item[meta.extraKey] || '' : '';

  const titleHtml = url
    ? `<a href="${escapeHtml(url)}" target="_blank" rel="noopener">${escapeHtml(name)}</a>`
    : escapeHtml(name);

  return `
    <div class="card">
      <div class="card-header">
        <div class="card-source-indicator" style="background:${color}"></div>
        <div style="flex:1">
          <div class="card-title">${titleHtml}</div>
          ${extra ? `<div class="card-authors">${escapeHtml(extra)}</div>` : ''}
          ${desc ? `<div class="card-summary">${escapeHtml(desc)}</div>` : ''}
        </div>
      </div>
    </div>`;
}

function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ─── Events ───
document.getElementById('tabs').addEventListener('click', e => {
  const tab = e.target.closest('.tab');
  if (!tab) return;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  tab.classList.add('active');
  currentCategory = tab.dataset.category;
  render();
});

document.getElementById('search').addEventListener('input', e => {
  searchQuery = e.target.value;
  render();
});

document.addEventListener('keydown', e => {
  if (e.key === '/' && document.activeElement !== document.getElementById('search')) {
    e.preventDefault();
    document.getElementById('search').focus();
  }
  if (e.key === 'Escape') {
    document.getElementById('search').blur();
    document.getElementById('search').value = '';
    searchQuery = '';
    render();
  }
});

// ─── Init ───
loadData();
</script>
</body>
</html>
